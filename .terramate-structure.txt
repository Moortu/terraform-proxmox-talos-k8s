TERRAMATE PROJECT STRUCTURE
===========================

terraform-proxmox-talos-k8s/
â”‚
â”œâ”€â”€ ðŸ“„ terramate.tm.hcl              # Root Terramate configuration
â”œâ”€â”€ ðŸ“„ QUICKSTART.md                 # Quick start guide
â”œâ”€â”€ ðŸ“„ README-TERRAMATE.md           # Main Terramate documentation
â”œâ”€â”€ ðŸ“„ TERRAMATE-MIGRATION.md        # Detailed migration guide
â”‚
â”œâ”€â”€ ðŸ“ config/                        # Shared Terramate configuration
â”‚   â”œâ”€â”€ globals.tm.hcl               # Global variables (versions, paths)
â”‚   â”œâ”€â”€ generate_providers.tm.hcl    # Auto-generate provider configs
â”‚   â””â”€â”€ generate_backend.tm.hcl      # Auto-generate backend configs
â”‚
â”œâ”€â”€ ðŸ“ stacks/                        # Infrastructure stacks
â”‚   â”œâ”€â”€ .gitignore                   # Stack-specific gitignore
â”‚   â”‚
â”‚   â””â”€â”€ ðŸ“ production/               # Production environment
â”‚       â”‚
â”‚       â”œâ”€â”€ ðŸ“ 01-talos-iso/         # [OPTIONAL] Separate ISO stack
â”‚       â”‚   â”œâ”€â”€ stack.tm.hcl         # Stack metadata
â”‚       â”‚   â”œâ”€â”€ main.tf              # ISO download logic
â”‚       â”‚   â”œâ”€â”€ variables.tf         # Input variables
â”‚       â”‚   â””â”€â”€ outputs.tf           # Outputs
â”‚       â”‚
â”‚       â””â”€â”€ ðŸ“ cluster/              # [MAIN] Complete cluster stack
â”‚           â”œâ”€â”€ stack.tm.hcl         # Stack definition
â”‚           â”œâ”€â”€ main.tf              # Main infrastructure code
â”‚           â”œâ”€â”€ variables.tf         # All variables
â”‚           â”œâ”€â”€ outputs.tf           # Cluster outputs
â”‚           â”œâ”€â”€ terraform.tfvars.example  # Example config
â”‚           â”œâ”€â”€ terraform.tfvars     # Your config (gitignored)
â”‚           â”œâ”€â”€ README.md            # Stack documentation
â”‚           â””â”€â”€ _generated_*.tf      # Auto-generated (gitignored)
â”‚
â””â”€â”€ ðŸ“ modules/                       # Reusable Terraform modules (unchanged)
    â”œâ”€â”€ download_talos_iso/
    â”œâ”€â”€ create_vms_control_plane/
    â”œâ”€â”€ create_vms_workers/
    â”œâ”€â”€ create_talos_config/
    â”œâ”€â”€ boot_talos_nodes/
    â”œâ”€â”€ generate_cilium_manifest/
    â”œâ”€â”€ fluxcd/
    â””â”€â”€ argocd/


WORKFLOW
========

1. Configure
   â””â”€> Edit stacks/production/cluster/terraform.tfvars

2. Generate
   â””â”€> terramate generate
       â””â”€> Creates _generated_providers.tf in each stack

3. Deploy
   â””â”€> cd stacks/production/cluster
       â””â”€> terraform init
           â””â”€> terraform apply


STACK DEPENDENCIES (if using separate stacks)
=============================================

01-talos-iso
    â”‚
    â”œâ”€â”€> Downloads Talos ISO to Proxmox
    â”‚
    â””â”€â”€> Outputs: talos_iso_path, talos_installer_image_url
            â”‚
            â–¼
        cluster
            â”‚
            â”œâ”€â”€> Creates VMs
            â”œâ”€â”€> Configures Talos
            â”œâ”€â”€> Bootstraps K8s
            â””â”€â”€> Deploys GitOps


CURRENT SETUP
=============

You have ONE main stack:
  stacks/production/cluster/

This stack contains ALL components:
  âœ“ ISO download
  âœ“ VM creation
  âœ“ Talos configuration
  âœ“ Cluster bootstrap
  âœ“ GitOps deployment

This is the RECOMMENDED approach for most users.


ALTERNATIVE: SPLIT STACKS
==========================

For advanced users, you can split into multiple stacks:

stacks/production/
â”œâ”€â”€ 01-talos-iso/       # ISO preparation
â”œâ”€â”€ 02-vms/             # VM creation
â”œâ”€â”€ 03-talos-config/    # Talos configuration
â”œâ”€â”€ 04-bootstrap/       # Cluster bootstrap
â””â”€â”€ 05-gitops/          # GitOps deployment

Benefits:
  âœ“ Granular control
  âœ“ Independent updates
  âœ“ Parallel execution

Drawbacks:
  âœ— More complex
  âœ— State management
  âœ— Inter-stack dependencies


TERRAMATE COMMANDS
==================

List stacks:
  $ terramate list

Generate code:
  $ terramate generate

Run in all stacks:
  $ terramate run terraform init
  $ terramate run terraform plan
  $ terramate run terraform apply

Run in specific stack:
  $ terramate run --chdir stacks/production/cluster terraform apply

Run changed stacks only:
  $ terramate run --changed terraform apply

Parallel execution:
  $ terramate run --parallel 3 terraform plan


ENVIRONMENT VARIABLES
=====================

Terramate respects standard Terraform environment variables:

  TF_VAR_*              # Variable values
  PROXMOX_VE_API_TOKEN  # Proxmox auth
  KUBECONFIG            # Kubernetes config
  TALOSCONFIG           # Talos config


GENERATED FILES
===============

After running 'terramate generate', you'll see:

stacks/production/cluster/
â””â”€â”€ _generated_providers.tf

This file contains:
  âœ“ Terraform version constraints
  âœ“ Provider requirements
  âœ“ Provider configurations

DO NOT EDIT generated files manually!
They are recreated on each 'terramate generate'.


GITIGNORE
=========

The following are gitignored:

  âœ“ **/_generated_*.tf
  âœ“ **/.terraform/
  âœ“ **/terraform.tfstate*
  âœ“ **/*.tfvars (except *.tfvars.example)
  âœ“ **/generated/ (kubeconfig, talosconfig)


MIGRATION NOTES
===============

Old files (in project root):
  main.tf              â†’ stacks/production/cluster/main.tf
  outputs.tf           â†’ stacks/production/cluster/outputs.tf
  vars-*.tf            â†’ stacks/production/cluster/variables.tf
  versions.tf          â†’ stacks/production/cluster/variables.tf
  example.tfvars       â†’ stacks/production/cluster/terraform.tfvars.example

Modules:
  modules/             â†’ Unchanged, referenced as ../../../modules/

State:
  terraform.tfstate    â†’ stacks/production/cluster/terraform.tfstate
                         (or remote backend if configured)
